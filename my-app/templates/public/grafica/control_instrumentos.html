{% extends 'public/base_cpanel.html' %}
{% block title %}Control de Instrumentos{% endblock %}
{% block body %}

<div class="container mt-5">
  <h2 class="text-center mb-4">Análisis por Instrumento y Infante</h2>

  <!-- Formulario de filtro -->
  <form id="filtro-form" class="mb-4">
    <div class="row">
      <div class="col-md-4">
        <label for="instrumentoSelect" class="form-label">Seleccione el Instrumento:</label>
        <select id="instrumentoSelect" class="form-select">
          <option value="" disabled selected>Seleccione un instrumento</option>
          {% for instrumento in instrumentos %}
          <option value="{{ instrumento.id_instrumento }}">{{ instrumento.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label for="infanteSelect" class="form-label">Seleccione el Infante:</label>
        <select id="infanteSelect" class="form-select">
          <option value="" disabled selected>Seleccione un infante</option>
          {% for infante in infantes %}
          <option value="{{ infante.id_infante }}">{{ infante.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
      </div>
    </div>
  </form>

  <!-- Gráficas separadas -->
  <div class="row g-5">

    <div class="col-md-6">
      <div class="card">
        <div class="card-header text-center"><b>Duración (s)</b></div>
        <div class="card-body"><canvas id="graficaDuracion"></canvas></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header text-center"><b>Aceleración</b></div>
        <div class="card-body"><canvas id="graficaAceleracion"></canvas></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header text-center"><b>Velocidad</b></div>
        <div class="card-body"><canvas id="graficaVelocidad"></canvas></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header text-center"><b>Giros</b></div>
        <div class="card-body"><canvas id="graficaGiros"></canvas></div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Función principal para actualizar las gráficas cuando se cambia de instrumento y infante
document.getElementById('filtro-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id_instrumento = document.getElementById('instrumentoSelect').value;
  const id_infante = document.getElementById('infanteSelect').value;

  // Validación para asegurar que ambos filtros estén seleccionados
  if (!id_instrumento || !id_infante) {
    alert('Por favor, seleccione tanto el instrumento como el infante.');
    return;
  }

  // Realizamos el fetch para obtener los datos de todas las sesiones del instrumento e infante seleccionado
  const response = await fetch(`/api/datos-instrumento-infante/${id_instrumento}/${id_infante}`);
  const data = await response.json();

  const sesiones = data.sesiones;
  const duraciones = data.duraciones;
  const aceleraciones = data.aceleraciones;
  const velocidades = data.velocidades;
  const giros = data.giros;

  // Si los datos no están vacíos, actualizamos las gráficas
  if (data && sesiones.length > 0) {
    renderGrafica('graficaDuracion', sesiones, duraciones, '#FF6384');
    renderGrafica('graficaAceleracion', sesiones, aceleraciones, '#36A2EB');
    renderGrafica('graficaVelocidad', sesiones, velocidades, '#FFCE56');
    renderGrafica('graficaGiros', sesiones, giros, '#4BC0C0');
  } else {
    alert('No se encontraron datos para este instrumento e infante.');
  }
});

function renderGrafica(canvasId, labels, data, color) {
  const ctx = document.getElementById(canvasId).getContext('2d');

  // Si ya existe una gráfica, la destruimos para crear una nueva
  if (window[canvasId]) {
    window[canvasId].destroy();
  }

  // Creamos la nueva gráfica
  window[canvasId] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: canvasId.replace('grafica',''),
        data: data,
        borderColor: color,
        backgroundColor: color + '33',  // Color de fondo más transparente
        tension: 0.3,  // Aumentamos la curva para el polígono
        fill: true  // Rellenamos el área bajo la curva
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: { 
        y: { beginAtZero: true }  // Aseguramos que el eje Y empiece en 0
      }
    }
  });
}
</script>

{% endblock %}
